# Implant

### Категория: Forensics
### Сложность: hard

##### Описание:

Почему клавиатура стала медленнее?.. Может все из-за расчетов?..

(Не забудьте обернуть строку в  ```ctfcup{}```)

##### Решение:

1. У нас есть захваченный USB-трафик с клавиатуры. Мы можем получить данные оттуда, если знаем структуру ```URB_INTERRUPT```.
2. Нам нужна секция ```Leftover Capture Data```:
3. ![1](https://i.ibb.co/P1Swn6d/1.jpg)
4. Для начала отфильтруем ненужные пакеты:
5. ```tshark -r capture.pcapng -Y 'usb.transfer_type==0x01 && (frame.len==72) && !(usb.capdata == 00:00:00:00:00:00:00:00) && !(usb.capdata == 02:00:00:00:00:00:00:00)' -V | grep 'Leftover Capture Data:' | sed 's|Leftover Capture Data: ||g'```
6. У нас есть список нужных пакетов, можем конвертить в символы:
7. ![2](https://i.ibb.co/C5FwTkL/2.jpg)
8. Программное решение этой задачи (я использовал [это](https://gist.github.com/MightyPork/6da26e382a7ad91b5496ee55fdc73db2) для кодов клавиатуры):
```python
m = ['0200070000000000', '0000080000000000', '0000040000000000', '0000150000000000', '00002c0000000000',
     '0200160000000000', '0000160000000000', '0000100000000000', '00000c0000000000', '0000170000000000',
     '0000170b00000000', '00000b0000000000', '02001e0000000000', '0000280000000000', '0000280000000000',
     '02000c0000000000', '0000170000000000', '00002c0000000000', '0000160000000000', '0000080000000000',
     '0000080000000000', '0000100000000000', '0000160000000000', '0000162c00000000', '00002c0000000000',
     '02000c0000000000', '0000340000000000', '0000100000000000', '00002c0000000000', '0000160000000000',
     '0000170000000000', '0000040000000000', '0000150000000000', '0000170000000000', '00000c0000000000',
     '0000110000000000', '00000a0000000000', '00000a2c00000000', '00002c0000000000', '0000170000000000',
     '0000120000000000', '00002c0000000000', '0000160000000000', '0000180000000000', '0000160000000000',
     '0000130000000000', '0000080000000000', '0000080600000000', '0000060000000000', '0000170000000000',
     '0000172c00000000', '00002c0000000000', '0000160000000000', '0000120000000000', '0000100000000000',
     '0000080000000000', '0000170000000000', '00000b0000000000', '00000c0000000000', '0000110000000000',
     '00000a0000000000', '0000370000000000', '0000280000000000', '0200100000000000', '00001c0000000000',
     '00002c0000000000', '00000e0000000000', '0000080000000000', '00001c0000000000', '0000050000000000',
     '0000120000000000', '0000040000000000', '0000150000000000', '0000070000000000', '0000072c00000000',
     '00002c0000000000', '00001a0000000000', '0000120000000000', '0000150000000000', '00000e0000000000',
     '0000160000000000', '0000162c00000000', '00002c0000000000', '0000190000000000', '0000190800000000',
     '0000080000000000', '0000081500000000', '0000150000000000', '00001c0000000000', '00002c0000000000',
     '0000160000000000', '00000f0000000000', '0000120000000000', '00001a0000000000', '00000f0000000000',
     '00001c0000000000', '0000360000000000', '00002c0000000000', '00000c0000000000', '0000170000000000',
     '0000172c00000000', '00002c0000000000', '0000090000000000', '0000080000000000', '0000080000000000',
     '00000f0000000000', '0000160000000000', '0000162c00000000', '00002c0000000000', '00000f0000000000',
     '00000c0000000000', '00000e0000000000', '0000080000000000', '0000082c00000000', '00002c0000000000',
     '00000c0000000000', '0000170000000000', '0000172c00000000', '00002c0000000000', '0000160000000000',
     '0000170000000000', '0000040000000000', '0000041500000000', '0000150000000000', '0000170000000000',
     '0000160000000000', '0000162c00000000', '00002c0000000000', '0000170000000000', '0000120000000000',
     '00002c0000000000', '0000050000000000', '0000150000000000', '0000150800000000', '0000080000000000',
     '0000040000000000', '00000e0000000000', '0000370000000000', '0000280000000000', '02000c0000000000',
     '00002c0000000000', '00001a0000000000', '0000150000000000', '0000120000000000', '0000170000000000',
     '0000080000000000', '0000082c00000000', '00002c0000000000', '0000040000000000', '0000050000000000',
     '0000120000000000', '0000180000000000', '0000170000000000', '0000172c00000000', '00002c0000000000',
     '0000170000000000', '00000b0000000000', '0000080000000000', '0000082c00000000', '00002c0000000000',
     '0000130000000000', '0000120000000000', '0000160000000000', '0000160000000000', '00000c0000000000',
     '0000050000000000', '00000f0000000000', '0000080000000000', '0000082c00000000', '00002c0000000000',
     '0000060000000000', '0000060400000000', '0000040000000000', '0000180000000000', '0000160000000000',
     '0000160800000000', '0000080000000000', '0000082c00000000', '00002c0000000000', '0000120000000000',
     '0000090000000000', '0000092c00000000', '00002c0000000000', '0000050000000000', '0000150000000000',
     '0000150800000000', '0000080000000000', '0000040000000000', '00000e0000000000', '0000070000000000',
     '0000120000000000', '00001a0000000000', '0000110000000000', '0000360000000000', '00002c0000000000',
     '0000060000000000', '0000060400000000', '0000040000000000', '0000110000000000', '00002c0000000000',
     '00001c0000000000', '0000120000000000', '0000180000000000', '00002c0000000000', '0000160000000000',
     '0000080000000000', '0000080000000000', '0200380000000000', '0000280000000000', '00000b0000000000',
     '0000170000000000', '0000170000000000', '0000130000000000', '0000160000000000', '0200330000000000',
     '0000380000000000', '0000380000000000', '0000130000000000', '0000040000000000', '0000041600000000',
     '0000160000000000', '0000170000000000', '0000080000000000', '0000050000000000', '00000c0000000000',
     '0000110000000000', '0000370000000000', '0000060000000000', '0000120000000000', '0000100000000000',
     '0000380000000000', '0000150000000000', '0000040000000000', '0000041a00000000', '00001a0000000000',
     '0000380000000000', '02000a0000000000', '00000a0000000000', '0000220000000000', '0000200000000000',
     '0000050000000000', '0000240000000000', '00001d0000000000', '02001b0000000000', '00001b0000000000',
     '0000260000000000', '0000280000000000', '0000280000000000', '02000c0000000000', '00002c0000000000',
     '00000b0000000000', '0000120000000000', '0000130000000000', '0000080000000000', '0000082c00000000',
     '00002c0000000000', '0000090000000000', '0000120000000000', '0000150000000000', '0000152c00000000',
     '00002c0000000000', '00001c0000000000', '0000120000000000', '0000180000000000', '0000150000000000',
     '0000152c00000000', '00002c0000000000', '0000140000000000', '0000180000000000', '00000c0000000000',
     '0000060000000000', '00000e0000000000', '00002c0000000000', '0000150000000000', '0000150800000000',
     '0000080000000000', '0000130000000000', '00000f0000000000', '00001c0000000000', '0000360000000000',
     '00002c0000000000', '02001b0000000000', '02001b0000000000', '02001b0000000000']

keys = {'04': 'a', '05': 'b', '06': 'c', '07': 'd', '08': 'e', '09': 'f', '0a': 'g', '0b': 'h', '0c': 'i', '0d': 'j',
        '0e': 'k', '0f': 'l', '10': 'm', '11': 'n', '12': 'o', '13': 'p', '14': 'q', '15': 'r', '16': 's', '17': 't',
        '18': 'u', '19': 'v', '1a': 'w', '1b': 'x', '1c': 'y', '1d': 'z', '020004': 'A', '020005': 'B', '020006': 'C',
        '020007': 'D', '020008': 'E', '020009': 'F', '02000a': 'G', '02000b': 'H', '02000c': 'I', '02000d': 'J',
        '02000e': 'K', '02000f': 'L', '020010': 'M', '020011': 'N', '020012': 'O', '020013': 'P', '020014': 'Q',
        '020015': 'R', '020016': 'S', '020017': 'T', '020018': 'U', '020019': 'V', '02001a': 'W', '02001b': 'X',
        '02001c': 'Y', '02001d': 'Z', '20': '3', '22': '5', '24': '7', '26': '9', '28': '\n', '2c': ' ', '33': ':',
        '34': "'", '36': ',', '02001e': '!', '37': '.', '020038': '?', '38': '/', }

for i in range(len(m)):
    # remove sticky keys
    if m[i][6:8] == '00':
        # upper
        if m[i][:6] in keys.keys():
            print(keys[m[i][:6]], end='')
        # lower
        elif m[i][4:6] in keys.keys():
            # if we have two simultaneous interruptions
            if i != 0 and m[i - 1][:6] == '0200' + m[i][4:6]:
                pass
            else:
                print(keys[m[i][4:6]], end='')
```
9. Теперь у нас есть ссылка на пост ```pastebin```: ```https://pastebin.com/raw/G53b7zX9```
10. Надо решить систему линейных уравнений. С помощью ```sagemath``` получаем решения:
11. ![3](https://i.ibb.co/XSB7Y88/3.jpg)
12. И в конце концов флаг:
13. ```ctfcup{f0R3nS1cK3e3l0G}```
